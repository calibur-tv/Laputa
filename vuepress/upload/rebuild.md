# 多季度视频的当前实现方案：
##### 季度信息的存储
`bangumis`表下面有一个`season`字段，存储的是`json string`，因为`MySQL 5.6 `不支持存储`JSON`，所以我们每次读和写的时候都要`parse`一下
`season`字段有如下`key`
``` json
{
  "part": "<Array> | 每个季度是从哪里开始分割",
  "name": "<Array> | 每个季度的名字",
  "time": "<Array> | 每个季度的上线时间",
  "re": "<Number | Array> 每个季度的集数是否从1开始重排序，默认值 0 不重新排序"
}
```
1. 举个例子：
**《刀剑神域》**的`season`：
```json
{
  "name": ["Sword Art Online", "Gun Gale Online", "序列之争","外传GGO","刀剑神域 Alicization"], 
  "part": [0, 25, 50, 51, 64, 88],
  "time": ["2012.7", "2014.7", "2017.2","2018.4","2018.10"],
  "re": 1
}
```
`season`各字段简介：
1. 这个字段可为空
2. part 是多个数组（区间），代表季度的集数，比如第一季是1 ~ 12, 第二季是 13 ~ 24，那么 part = [0, 12, 24]。第一个 0 代表从第一集开始，12 - 0 = 12，24 -12 = 12，代表第一季有12集，第二季有12集
4. time 和 name 代表该季度的上映日期和名称，如果没有特殊名称，就填写'第一季、第二季'
5. 假设 part 有 N 个，那么 time 和 name 就有 N - 1 个，因此 part 至少是两个
6. part 必须是升序排列的，从 0 开始，当番剧未完结时，最后一位是 -1
7. re 代表每个季度之间的集数是否重排，如果是 1 则重拍，如果是 0 或不填则不重排
9. re 也可以和 name 是一个数组，但它的长度必须和 name 一样，并且每一项都是 0 或 1

##### 视频信息的存储
`videos`的三个字段是关键：`part`、`url`、`resource`
1. `part` 就是集数，是一个`int`型，从 1 开始
2. `url` 是一个字符串，可能为空，存储的是`站外资源播放地址`，可能是 bilibili 的网页也可能是优酷、爱奇艺的网页
3. `resource` 是一个`json`，里面存储的大致是如下内容：
```json
{
  "video": {
    "720": {
      "useLyc": "<Boolean> | 是否使用字幕",
      "src": "<String> | 自建视频的播放地址"
    },
    "1080": "与720相同",
    "480": "..."
  },
  "lyric": {
    "zh": "<String> | 中文字幕 url",
    "en": "<String> | 英文字幕 url"
  }
}
```
> 我们一开始打算支持多种画质和外链字幕，但是后来发现有很多问题，比如：
1. 字幕的格式要求单一，绝大部分的资源提供的字幕格式无法在web网页使用
2. 要去找多重清晰度的资源会增大工作量，因此为了简化工作只去搜集了 720P 资源，部分资源是 1080P 的
3. 如果采用云存储的转码，费用会非常高，并且占用存储，最终的结果并不理想
> 所以结论是：我们只支持`内嵌字幕`的`单一画质`视频即可


##### 如何计算内建资源和版权方播放地址？
`bangumis`表下面还有一个`others_site_video`字段，这个字段是一开始为了快速切换`自建`视频和`版权方视频`而设置的，一开始我们的视频资源还比较少，所以用一个字段控制就行了

只要版权方找过来，我们修改这个`others_site_video`值为`true`前端根据接口返回的这个字段判断是加载一个视频播放器还是渲染一个`无版权，点击跳转`的按钮

有一个问题是：
> 当一个番剧有多个季度的番，第一二季是没有版权的，第三季是有版权的，那么通过`others_site_video`字段来判断就不行了，因此现在的方案是[代码](https://github.com/calibur-tv/Laputa/blob/deploy/app/Api/v1/Repositories/VideoRepository.php#L16)：
1. 服务端在接口里通过计算，根据`resource`和`url`的值最终算出一个`src`，它可能是空字符串，也可能是外站资源链接，也可能是我们的视频资源。
2. 当`others_site_video`为`true`的时候，API 只去读取`url`的值而不去计算`resource`内的数据，这样会让**整个番剧的所有季度都跳到版权方**
3. 当`others_site_video`为`false`的时候，会通过`url`和`resource`计算出一个`src`，并且优先使用我们自己的播放链接，如果我们的播放链接是空，就会回退到版权方的链接
4. 最终如果`src`返回是空字符串，前端就会展示`视频消失了`

##### 目前是如何把`season` 和 `part` 关联起来的？
主要是通过`season`里的`part`和`re`两个字段一顿算，然后结合`videos`表里的`part`得出来的多季度列表，[计算的函数](https://github.com/calibur-tv/Laputa/blob/deploy/app/Api/v1/Repositories/BangumiRepository.php#L175)
因为这个视频功能是在演进的，一开始也没有考虑周到，所以导致现在出现的问题是：
1. 通过时间区间来搜索番剧，无法精确到每个季度的时间（`season`里存储的`time`不利于索引）
2. 写漫评的时候，无法支持多个季度分开写（是根据`bangumi_id`和`user_id`来确认漫评唯一性的）
3. `video`的集数无法支持`0.5`，`1.6`，`0`这样的莫名其妙一开始我没想到的集数。。。
4. 另外一点`part`这样整数话处理的原因是前期我们的视频都是批量上传到七牛云，然后批量写入到数据库里的，所以无法对`part`做差异化，只能是一个`for`循环去写入
5. 这里的代码已经很乱了，基本我自己看半天才能想明白，所以**建议重写**吧